# 虚树

## 概念

对于一棵树，仅仅保留有用的点，重新构建一棵树（有用的点是指询问点和他们的$lca$）

## 构建

考虑得到了询问点，如何构造一颗虚树；我们对整颗树$dfs$一遍，求出他们的$dfs$序，然后对每个节点以$dfs$序为关键字排序；同时维护一个栈，表示从根到栈顶元素这条链；假设当前加入的节点为$p$，栈顶元素为$x=s[top]$，$lca$为他们的最近公共祖先，因为按照$dfs$序，因此$lca$不可能是$p$。此时有两种情况：

1. $lca$是$x$，直接将$p$入栈
2. $x$，$p$分别位于$lca$的两颗子树中，则此时$x$这颗子树已经遍历完毕

栈顶元素为$x$，后一个元素为$y$

* 若$dfn[y]>dfn[lca]$，可以连边$y\rightarrow x$，将$x$出栈
* 若$dfn[y]=dfn[lca]$，即$y=lca$，连边$lca\rightarrow x$，此时子树构建完毕
* 若$dfn[y]<dfn[lca]$，即$lca$在$y,x$之间，连边$lca\rightarrow x$，$x$出栈，再将$lca$入栈

